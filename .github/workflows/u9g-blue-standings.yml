name: U9G Blue Standings Weekly Email

on:
  workflow_dispatch:

jobs:
  standings:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests beautifulsoup4 openai

     - name: Fetch EMSA Schedule Page
      run: |
        python << 'EOF'
        import requests
        import sys

        url = "https://emsamain.com/schedules/"

        headers = {
            "User-Agent": (
                "Mozilla/5.0 (Windows NT 10.0; Win64; x64) "
                "AppleWebKit/537.36 (KHTML, like Gecko) "
                "Chrome/120.0.0.0 Safari/537.36"
            )
        }

        try:
            response = requests.get(url, headers=headers, timeout=30)
            response.raise_for_status()
        except Exception as e:
            print("❌ ERROR: Failed to fetch schedule URL.")
            print(e)
            sys.exit(1)

        try:
            with open("schedule.html", "w", encoding="utf-8") as f:
                f.write(response.text)
        except Exception as e:
            print("❌ ERROR: Failed to save schedule.html")
            print(e)
            sys.exit(1)
        EOF

    - name: Extract U9G Blue Games
      run: |
        python << 'EOF'
        import sys
        from bs4 import BeautifulSoup

        try:
            with open("schedule.html", "r", encoding="utf-8") as f:
                html = f.read()
        except Exception as e:
            print("❌ ERROR: Could not read schedule.html")
            print(e)
            sys.exit(1)

        try:
            soup = BeautifulSoup(html, "html.parser")
            text = soup.get_text(separator="\n")
        except Exception as e:
            print("❌ ERROR: Failed to parse HTML")
            print(e)
            sys.exit(1)

        if not text.strip():
            print("❌ ERROR: Extracted text is empty — website may have changed or blocked scraping.")
            sys.exit(1)

        try:
            with open("games.txt", "w", encoding="utf-8") as f:
                f.write(text)
        except Exception as e:
            print("❌ ERROR: Failed to save games.txt")
            print(e)
            sys.exit(1)
        EOF

    - name: Generate Standings with ChatGPT
      env:
        OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      run: |
        python << 'EOF'
        import sys
        import openai

        client = openai.OpenAI(api_key="${OPENAI_API_KEY}")

        try:
            with open("games.txt", "r", encoding="utf-8") as f:
                games_text = f.read()
        except Exception as e:
            print("❌ ERROR: Could not read games.txt")
            print(e)
            sys.exit(1)

        if len(games_text.strip()) < 50:
            print("❌ ERROR: games.txt appears too small — extraction likely failed.")
            sys.exit(1)

        prompt = f"""
        Here is a full text dump of a soccer schedule webpage. Extract only completed
        games from the U9G Blue division. Ignore future-dated games and BYE games.
        Calculate standings using:
        - 3 points for a win
        - 1 point for a draw
        - 0 points for a loss

        Return a clean table in this format:

        Team | GP | W | D | L | GF | GA | GD | Points

        Here is the schedule text:
        {games_text}
        """

        try:
            response = client.chat.completions.create(
                model="gpt-4o-mini",
                messages=[{"role": "user", "content": prompt}]
            )
            standings = response.choices[0].message["content"]
        except Exception as e:
            print("❌ ERROR: ChatGPT API call failed")
            print(e)
            sys.exit(1)

        if not standings or len(standings.strip()) == 0:
            print("❌ ERROR: ChatGPT returned empty standings")
            sys.exit(1)

        try:
            with open("standings.txt", "w", encoding="utf-8") as f:
                f.write(standings)
        except Exception as e:
            print("❌ ERROR: Failed to write standings.txt")
            print(e)
            sys.exit(1)
        EOF

    - name: Send Email with Gmail SMTP
      env:
        SMTP_USERNAME: ${{ secrets.SMTP_USERNAME }}
        SMTP_PASSWORD: ${{ secrets.SMTP_PASSWORD }}
        SMTP_SERVER: ${{ secrets.SMTP_SERVER }}
        SMTP_PORT: ${{ secrets.SMTP_PORT }}
      run: |
        python << 'EOF'
        import smtplib
        import sys
        from email.mime.text import MIMEText

        try:
            with open("standings.txt", "r", encoding="utf-8") as f:
                standings = f.read()
        except Exception as e:
            print("❌ ERROR: Could not read standings.txt")
            print(e)
            sys.exit(1)

        if not standings.strip():
            print("❌ ERROR: standings.txt is empty")
            sys.exit(1)

        msg = MIMEText(standings)
        msg["Subject"] = "U9G Blue Weekly Standings"
        msg["From"] = "${SMTP_USERNAME}"
        msg["To"] = "tonyvanherk@gmail.com"

        try:
            with smtplib.SMTP("${SMTP_SERVER}", ${SMTP_PORT}, timeout=30) as server:
                server.starttls()
                server.login("${SMTP_USERNAME}", "${SMTP_PASSWORD}")
                server.send_message(msg)
        except Exception as e:
            print("❌ ERROR: Failed to send email")
            print(e)
            sys.exit(1)
        EOF
